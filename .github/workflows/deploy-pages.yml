name: Deploy SPA to Cloudflare Pages

on:
  push:
    branches: [main]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      NPM_CONFIG_LEGACY_PEER_DEPS: "true"
      CF_PAGES_PROJECT: "launchwing-app"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install deps (workspaces ok)
        run: npm install --no-audit --no-fund -ws

      - name: Build SPA â†’ app/dist
        run: npm run -w app build

      # Inject Pages Advanced Mode worker (proxies /api/*, handles OPTIONS+CORS)
      - name: Write _worker.js (Advanced proxy)
        run: |
          cat > app/dist/_worker.js <<'JS'
          const ORCH = "https://launchwing-orchestrator.promptpulse.workers.dev";
          function corsHeaders() {
            return {
              "Access-Control-Allow-Origin": "*",
              "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
              "Access-Control-Allow-Headers": "Content-Type, Authorization, X-Requested-With",
              "Vary": "Origin",
            };
          }
          function corsPreflight() {
            return new Response(null, { status: 204, headers: corsHeaders() });
          }
          async function serveSPA(req, env) {
            const res = await env.ASSETS.fetch(req);
            if (res.status !== 404) return res;
            const accepts = req.headers.get("accept") || "";
            const isGetLike = req.method === "GET" || req.method === "HEAD";
            if (isGetLike && accepts.includes("text/html")) {
              const url = new URL(req.url);
              const indexReq = new Request(new URL("/index.html", url), req);
              const indexRes = await env.ASSETS.fetch(indexReq);
              if (indexRes.status !== 404) return indexRes;
            }
            return res;
          }
          export default {
            async fetch(req, env) {
              const url = new URL(req.url);
              if (url.pathname.startsWith("/api/")) {
                if (req.method === "OPTIONS") return corsPreflight();
                const upstream = new URL(url.pathname.replace(/^\/api/, ""), ORCH);
                upstream.search = url.search;
                const init = {
                  method: req.method,
                  headers: req.headers,
                  body: (req.method === "GET" || req.method === "HEAD") ? undefined : req.body,
                  redirect: "manual",
                };
                const r = await fetch(upstream.toString(), init);
                const h = new Headers(r.headers);
                for (const [k, v] of Object.entries(corsHeaders())) h.set(k, v);
                return new Response(r.body, { status: r.status, statusText: r.statusText, headers: h });
              }
              return serveSPA(req, env);
            },
          };
          JS
          test -f app/dist/_worker.js || (echo "ERROR: app/dist/_worker.js missing" && exit 1)

      # Create Pages project if it doesn't exist (idempotent)
      - name: Ensure Pages project exists
        continue-on-error: true
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken:  ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: "4"
          command: >
            pages project create ${{ env.CF_PAGES_PROJECT }}
            --production-branch main
            --compatibility-date 2024-11-01

      # Deploy with built-in action (no custom --config)
      - name: Deploy to Pages (Advanced Mode)
        id: deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken:  ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: "4"
          command: >
            --cwd app
            pages deploy dist
            --project-name ${{ env.CF_PAGES_PROJECT }}
            --branch main
            --commit-dirty=true

      # Simple retry once if the API flakes (e.g., 503)
      - name: Retry deploy once on failure
        if: failure()
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken:  ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          wranglerVersion: "4"
          command: >
            --cwd app
            pages deploy dist
            --project-name ${{ env.CF_PAGES_PROJECT }}
            --branch main
            --commit-dirty=true